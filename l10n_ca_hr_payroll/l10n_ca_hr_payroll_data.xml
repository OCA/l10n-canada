<?xml version="1.0" encoding="utf-8"?>
<openerp>
    <data noupdate="1">
    
    <!-- Deduction Category-->
    	<record id="FITF" model="hr.deduction.category">
            <field name="name">Canada - Contributions to pension plans (FIT_F)</field>
            <field name="code">FIT_F</field>
            <field name="description">Periodic contributions to RPP, RRSP, PRPP, or RCA</field>
            <field name="default_amount">0.0</field>
            <field name="jurisdiction">federal</field>
        </record>
        
        <record id="FITF2" model="hr.deduction.category">
            <field name="name">Canada - Alimony or maintenance payments required before May 1, 1997 (FIT_F2)</field>
            <field name="code">FIT_F2</field>
            <field name="description">Periodic alimony or maintenance payments required by a legal document dated before May 1, 1997, to be payroll-deducted authorized by a tax services office or tax centre.</field>
            <field name="default_amount">0.0</field>
            <field name="jurisdiction">federal</field>
        </record>
        
        <record id="FITU1" model="hr.deduction.category">
            <field name="name">Canada - Union dues (FIT_U1)</field>
            <field name="code">FIT_U1</field>
            <field name="description">Periodic union dues for the pay period paid to a trade union, an association of public servants, or dues required under the law of a province to a parity or advisory committee or similar body.</field>
            <field name="default_amount">0.0</field>
            <field name="jurisdiction">federal</field>
        </record>
        
        <record id="FITHD" model="hr.deduction.category">
            <field name="name">Canada - Annual deduction for living in a prescribed zone (FIT_HD)</field>
            <field name="code">FIT_HD</field>
            <field name="description">Annual deduction for living in a prescribed zone, as shown on Form TD1.</field>
            <field name="default_amount">0.0</field>
            <field name="jurisdiction">federal</field>
        </record>
        
        <record id="FITF1" model="hr.deduction.category">
            <field name="name">Canada - Annual deductions for child care and support payments (FIT_F1)</field>
            <field name="code">FIT_F1</field>
            <field name="description">Annual deductions such as child care expenses and support payments, requested by an employee or pensioner and authorized by a tax services office or tax centre.</field>
            <field name="default_amount">0.0</field>
            <field name="jurisdiction">federal</field>
        </record>
        
        <record id="FITK1" model="hr.deduction.category">
            <field name="name">Canada - Federal personal tax credit (FIT_K1)</field>
            <field name="code">FIT_K1</field>
            <field name="description">Federal non-refundable personal tax credit (the lowest federal tax rate is used to calculate this credit).</field>
            <field name="default_amount">0.0</field>
            <field name="jurisdiction">federal</field>
        </record>
        
        <record id="FITK3" model="hr.deduction.category">
            <field name="name">Canada - Other federal tax credits (FIT_K3)</field>
            <field name="code">FIT_K3</field>
            <field name="description">Other federal tax credits (such as medical expenses and charitable donations) authorized by a tax services office or tax centre.</field>
            <field name="default_amount">0.0</field>
            <field name="jurisdiction">federal</field>
        </record>
        
        <record id="FITLCF" model="hr.deduction.category">
            <field name="name">Canada - Federal labour-sponsored funds tax credit (FIT_LCF)</field>
            <field name="code">FIT_LCF</field>	
            <field name="description">Federal labour-sponsored funds tax credit.</field>
            <field name="default_amount">0.0</field>
            <field name="jurisdiction">federal</field>
        </record>
        
    

    <!-- Salary Rules Category -->

        <record id="I" model="hr.salary.rule.category">
            <field name="name">Taxable Income</field>
            <field name="code">I</field>
        </record>

        <record id="CALC" model="hr.salary.rule.category">
            <field name="code">CALC</field>
            <field name="name">Standard Calculation</field>
        </record>

        <record id="FCALC" model="hr.salary.rule.category">
            <field name="code">FCALC</field>
            <field name="name">Federal Calculation</field>
        </record>

        <record id="PCALC" model="hr.salary.rule.category">
            <field name="code">PCALC</field>
            <field name="name">Provincial Calculation</field>
        </record>

        <record id="EMP" model="hr.salary.rule.category">
            <field name="code">EMP</field>
            <field name="name">Employer Contribution</field>
        </record>

        <record id="SDED" model="hr.salary.rule.category">
            <field name="code">SDED</field>
            <field name="name">Source Deduction</field>
            <field name="note">Used for after tax deductions at source</field>
        </record>

        <record id="VAC" model="hr.salary.rule.category">
            <field name="code">VAC</field>
            <field name="name">Vacation Calculation</field>
        </record>

    <!-- Update salary rules of hr_payroll -->

        <record id="hr_payroll.hr_rule_basic" model="hr.salary.rule">
            <field name="appears_on_payslip" eval="0"/>
        </record>

        <record id="hr_payroll.hr_rule_taxable" model="hr.salary.rule">
            <field name="appears_on_payslip" eval="0"/>
        </record>

    <!-- Common rules to all canadian salary structures -->

        <record id="rule_ca_p" model="hr.salary.rule">
            <field name="name">Pays Per Year</field>
            <field name="sequence" eval="1"/>
            <field name="code">P</field>
            <field name="appears_on_payslip" eval="0"/>
            <field name="active" eval="1"/>
            <field name="category_id" ref="CALC"/>
            <field name="condition_select">none</field>
            <field name="amount_select">code</field>
            <field name="amount_python_compute">result = contract.pays_per_year or 0</field>
            <field name="note">Pays per year from the contract form</field>
        </record>

        <record id="rule_ca_pocc" model="hr.salary.rule">
            <field name="name">Payslip Counter (POCC)</field>
            <field name="sequence" eval="1"/>
            <field name="code">POCC</field>
            <field name="appears_on_payslip" eval="0"/>
            <field name="active" eval="1"/>
            <field name="category_id" ref="CALC"/>
            <field name="condition_select">none</field>
            <field name="amount_select">fix</field>
            <field name="quantity">1.0</field>
            <field name="amount_fix">1.0</field>
            <field name="note">Sloppy way of counting payslips for use in PR calc</field>
        </record>

        <record id="rule_ca_basic" model="hr.salary.rule">
            <field name="name">Basic per pay (BASICP)</field>
            <field name="sequence" eval="10"/>
            <field name="code">BASICP</field>
            <field name="appears_on_payslip" eval="1"/>
            <field name="active" eval="1"/>
            <field name="category_id" ref="CALC"/>
            <field name="condition_select">none</field>
            <field name="amount_select">code</field>
            <field name="amount_python_compute">result = BASIC / P</field>
        </record>

    <!-- Federal Income Tax - 170 -->

        <record id="rule_ca_fit_i" model="hr.salary.rule">
            <field name="name">FIT - Taxable Income (FIT_I)</field>
            <field name="sequence" eval="170"/>
            <field name="code">FIT_I</field>
            <field name="appears_on_payslip" eval="0"/>
            <field name="active" eval="1"/>
            <field name="category_id" ref="FCALC"/>
            <field name="condition_select">none</field>
            <field name="amount_select">code</field>
            <field name="amount_python_compute">
result = contract.sum_benefits(contract.id, payslip.date_from, payslip.date_to, exemption='fit_exempt', employer=True) + GROSS
            </field>
        </record>
        
        <record id="rule_ca_fit_f" model="hr.salary.rule">
            <field name="name">FIT - Taxable Income (FIT_F)</field>
            <field name="sequence" eval="171"/>
            <field name="code">FIT_F</field>
            <field name="appears_on_payslip" eval="0"/>
            <field name="active" eval="1"/>
            <field name="category_id" ref="FCALC"/>
            <field name="condition_select">none</field>
            <field name="amount_select">code</field>
            <field name="amount_python_compute">
result = employee.sum_deductions(contract.id, payslip.date_from, payslip.date_to, deduction_code='FIT_F')
            </field>
        </record>
        
        <record id="rule_ca_fit_f2" model="hr.salary.rule">
            <field name="name">FIT - Taxable Income (FIT_F2)</field>
            <field name="sequence" eval="171"/>
            <field name="code">FIT_F2</field>
            <field name="appears_on_payslip" eval="0"/>
            <field name="active" eval="1"/>
            <field name="category_id" ref="FCALC"/>
            <field name="condition_select">none</field>
            <field name="amount_select">code</field>
            <field name="amount_python_compute">
result = employee.sum_deductions(contract.id, payslip.date_from, payslip.date_to, deduction_code='FIT_F2')
            </field>
        </record>
        
        <record id="rule_ca_fit_U1" model="hr.salary.rule">
            <field name="name">FIT - Taxable Income (FIT_U1)</field>
            <field name="sequence" eval="171"/>
            <field name="code">FIT_U1</field>
            <field name="appears_on_payslip" eval="0"/>
            <field name="active" eval="1"/>
            <field name="category_id" ref="FCALC"/>
            <field name="condition_select">none</field>
            <field name="amount_select">code</field>
            <field name="amount_python_compute">
result = employee.sum_deductions(contract.id, payslip.date_from, payslip.date_to, deduction_code='FIT_U1')
            </field>
        </record>
        
        <record id="rule_ca_fit_hd" model="hr.salary.rule">
            <field name="name">FIT - Taxable Income (FIT_HD)</field>
            <field name="sequence" eval="171"/>
            <field name="code">FIT_HD</field>
            <field name="appears_on_payslip" eval="0"/>
            <field name="active" eval="1"/>
            <field name="category_id" ref="FCALC"/>
            <field name="condition_select">none</field>
            <field name="amount_select">code</field>
            <field name="amount_python_compute">
result = employee.sum_deductions(contract.id, payslip.date_from, payslip.date_to, deduction_code='FIT_HD')
            </field>
        </record>
        
        <record id="rule_ca_fit_f1" model="hr.salary.rule">
            <field name="name">FIT - Taxable Income (FIT_F1)</field>
            <field name="sequence" eval="171"/>
            <field name="code">FIT_F1</field>
            <field name="appears_on_payslip" eval="0"/>
            <field name="active" eval="1"/>
            <field name="category_id" ref="FCALC"/>
            <field name="condition_select">none</field>
            <field name="amount_select">code</field>
            <field name="amount_python_compute">
result = employee.sum_deductions(contract.id, payslip.date_from, payslip.date_to, deduction_code='FIT_F1')
            </field>
        </record>
        
        <record id="rule_ca_fit_a" model="hr.salary.rule">
            <field name="name">FIT - Taxable Income (FIT_A)</field>
            <field name="sequence" eval="171"/>
            <field name="code">FIT_A</field>
            <field name="appears_on_payslip" eval="0"/>
            <field name="active" eval="1"/>
            <field name="category_id" ref="FCALC"/>
            <field name="condition_select">none</field>
            <field name="amount_select">code</field>
            <field name="amount_python_compute">
result = P * (FIT_I - FIT_F - FIT_F2 - FIT_U1) - FIT_HD - FIT_F1
result = max(result, 0)
            </field>
        </record>
        
        <record id="rule_ca_fit_k1" model="hr.salary.rule">
            <field name="name">FIT - Taxable Income (FIT_K1)</field>
            <field name="sequence" eval="171"/>
            <field name="code">FIT_K1</field>
            <field name="appears_on_payslip" eval="0"/>
            <field name="active" eval="1"/>
            <field name="category_id" ref="FCALC"/>
            <field name="condition_select">none</field>
            <field name="amount_select">code</field>
            <field name="amount_python_compute">
result = employee.sum_deductions(contract.id, payslip.date_from, payslip.date_to, deduction_code='FIT_K1')
            </field>
        </record>
        
		<!-- 	
			FOR OTHER PROVINCES THAN QUEBEC, ADD THE FIT_K2 RULE
			It should correspond to YTD CPP + YTD EI 
		 	For Quebec, it is implemented in l10n_ca_hr_payroll_data.xml 
		-->
		
		        
        <record id="rule_ca_fit_k3" model="hr.salary.rule">
            <field name="name">FIT - Other federal tax credits (FIT_K3)</field>
            <field name="sequence" eval="171"/>
            <field name="code">FIT_K3</field>
            <field name="appears_on_payslip" eval="0"/>
            <field name="active" eval="1"/>
            <field name="category_id" ref="FCALC"/>
            <field name="condition_select">none</field>
            <field name="amount_select">code</field>
            <field name="amount_python_compute">
result = employee.sum_deductions(contract.id, payslip.date_from, payslip.date_to, deduction_code='FIT_K3')
            </field>
        </record>
        
        <record id="rule_ca_fit_k4" model="hr.salary.rule">
            <field name="name">FIT - Canada employment credit (FIT_K4)</field>
            <field name="sequence" eval="171"/>
            <field name="code">FIT_K4</field>
            <field name="appears_on_payslip" eval="0"/>
            <field name="active" eval="1"/>
            <field name="category_id" ref="FCALC"/>
            <field name="condition_select">none</field>
            <field name="amount_select">code</field>
            <field name="amount_python_compute">
result = min(FIT_A, 1127) * 15%
            </field>
        </record>
        
        <record id="rule_ca_fit_lcf" model="hr.salary.rule">
            <field name="name">FIT - Annual Federal labour-sponsored funds tax credit (FIT_LCF)</field>
            <field name="sequence" eval="171"/>
            <field name="code">FIT_LCF</field>
            <field name="appears_on_payslip" eval="0"/>
            <field name="active" eval="1"/>
            <field name="category_id" ref="FCALC"/>
            <field name="condition_select">none</field>
            <field name="amount_select">code</field>
            <field name="amount_python_compute">
result = employee.sum_deductions(contract.id, payslip.date_from, payslip.date_to, deduction_code='FIT_LCF')
            </field>
        </record>
        
        <record id="rule_ca_fit_t3" model="hr.salary.rule">
            <field name="name">FIT - Federal Income Tax (FIT_T3)</field>
            <field name="sequence" eval="172"/>
            <field name="code">FIT_T3</field>
            <field name="appears_on_payslip" eval="1"/>
            <field name="active" eval="1"/>
            <field name="category_id" ref="hr_payroll.DED"/>
            <field name="condition_select">none</field>
            <field name="amount_select">code</field>
            <field name="amount_python_compute">
brackets = [
	{'max': 43953, 'R': 15%, 'K': 0},
	{'max': 87907, 'R': 22%, 'K': 3077},
	{'max': 136270, 'R': 26%, 'K': 6593},
	{'max': 10**15, 'R': 29%, 'K': 10681}
]

for b in brackets:
	if FIT_A <= b['max']:
		result = FIT_A * b['R'] - b['K'] - QIT_K1 - QIT_K2 - QIT_K3 - QIT_K4
		break

result = max(result, 0)

        	</field>
        </record>
        
        <!--
        	FOR OTHER PROVINCES THAN QUEBEC, ADD THE FIT_T1 RULE
			It corresponds to Federal income tax for the period
		 	For Quebec, it is implemented in l10n_ca_hr_payroll_data.xml 
		-->

        <record id="rule_ca_fit_ytd" model="hr.salary.rule">
            <field name="name">FIT - Year To Date (FIT_YTD)</field>
            <field name="sequence" eval="173"/>
            <field name="code">FIT_YTD</field>
            <field name="category_id" ref="FCALC"/>
            <field name="appears_on_payslip" eval="1"/>
            <field name="active" eval="1"/>
            <field name="condition_select">none</field>
            <field name="amount_select">code</field>
            <field name="amount_python_compute">date_from = payslip.date_to.split('-')[0] + '-01-01'
date_to = payslip.date_to
result = payslip.sum('FIT_T1',date_from,date_to) + FIT_T1
            </field>
        </record>

        <!-- Vacation - 210 -->

        <record id="rule_ca_vac" model="hr.salary.rule">
            <field name="name">Vacation (VAC)</field>
            <field name="sequence" eval="210"/>
            <field name="code">VAC</field>
            <field name="category_id" ref="VAC"/>
            <field name="condition_select">none</field>
            <field name="amount_select">code</field>
            <field name="amount_python_compute">
result = contract.sum_benefits(contract.id, payslip.date_from, payslip.date_to, employer=True) + GROSS
result = (result * contract.weeks_of_vacation * 0.02)/P
			</field>
        </record>

        <record id="rule_ca_vac_ytd" model="hr.salary.rule">
            <field name="name">Vacation - Year To Date (VAC_YTD)</field>
            <field name="sequence" eval="211"/>
            <field name="code">VAC_YTD</field>
            <field name="category_id" ref="VAC"/>
            <field name="appears_on_payslip" eval="1"/>
            <field name="active" eval="1"/>
            <field name="condition_select">none</field>
            <field name="amount_select">code</field>
            <field name="amount_python_compute">date_from = payslip.date_to.split('-')[0] + '-01-01'
date_to = payslip.date_to
result = payslip.sum('VAC',date_from,date_to) + VAC
            </field>
        </record>

    <!-- Base for Canadian Salary Structure -->

        <record id="hr_structure_ca_base" model="hr.payroll.structure">
            <field name="code">CA</field>
            <field name="name">Canadian Base</field>
            <field eval="[(6, 0, [
        ref('rule_ca_p'),
        ref('rule_ca_pocc'),
        ref('rule_ca_basic'),
        ref('rule_ca_gross'),
        ref('rule_ca_fit_i'),
        ref('rule_ca_fit_f'),
        ref('rule_ca_fit_f2'),
        ref('rule_ca_fit_u1'),
        ref('rule_ca_fit_hd'),
        ref('rule_ca_fit_f1'),
        ref('rule_ca_fit_a'),
        ref('rule_ca_fit_k1'),
        ref('rule_ca_fit_k3'),
        ref('rule_ca_fit_k4'),
        ref('rule_ca_fit_lcf'),
        ref('rule_ca_fit_t3'),
        ref('rule_ca_fit_ytd'),
        ref('rule_ca_vac'),
        ref('rule_ca_vac_ytd')
        ])]" name="rule_ids"/>
        </record>

    </data>
</openerp>
